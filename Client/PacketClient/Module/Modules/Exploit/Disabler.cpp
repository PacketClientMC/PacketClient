#include "Disabler.h"

using namespace std;
Disabler::Disabler() : IModule(0, Category::EXPLOIT, "Disables certain anticheat checks") {
    registerEnumSetting("Mode", &mode, 0);
    mode.addEntry("GroundSpoof", 0);
    mode.addEntry("Cubecraft", 1);
    mode.addEntry("Cubecraft2", 2);
    mode.addEntry("Hive", 3);
    registerIntSetting("Ticks", &ticks, ticks, 1, 10);
    registerIntSetting("Multiplier", &multiplier, multiplier, 1, 200);
}

const char* Disabler::getRawModuleName() {
    return "Disabler";
}

const char* Disabler::getModuleName() {
    name = string("Disabler ") + string(GRAY) + mode.GetEntry(mode.getSelectedValue()).GetName();
    return name.c_str();
}

void Disabler::onEnable() {
    tick = 0;
}

void Disabler::onTick(GameMode* gm) {
    auto player = g_Data.getLocalPlayer();
    if (player == nullptr) return;
    tick++;

    switch (mode.getSelectedValue()) {
    case 0: // GroundSpoof
        MovePlayerPacket packet(g_Data.getLocalPlayer(), *g_Data.getLocalPlayer()->getPos()); packet.onGround = true;
        g_Data.getClientInstance()->loopbackPacketSender->sendToServer(&packet);
        break;
    }
}

void Disabler::onMove(MoveInputHandler* input) {
    auto player = g_Data.getLocalPlayer();
    if (player == nullptr) return;
}

void Disabler::onSendPacket(Packet* packet) {
    GameSettingsInput* input = g_Data.getClientInstance()->getGameSettingsInput();
    auto player = g_Data.getLocalPlayer();
    if (player == nullptr) return;

    auto scaffold = moduleMgr->getModule<Scaffold>();
    auto flight = moduleMgr->getModule<Flight>();
    auto speed = moduleMgr->getModule<Speed>();

    vec3_t pos = *player->getPos();
    double mathGroundRand = round(pos.y / 0.015625) * randomFloat(0.015625, 0.015629);
    float velocityxz = g_Data.getLocalPlayer()->velocity.magnitudexz();
    double mathGroundFly = round(pos.y / 0.015625) * 0.015645;
    double mathGround = round(pos.y / 0.015625) * 0.015625;

    if (packet->isInstanceOf<MovePlayerPacket>()) {
        MovePlayerPacket* movePacket = reinterpret_cast<MovePlayerPacket*>(packet);
        switch (mode.getSelectedValue()) {
        case 2: // Hive
            break;
        }
    }

    if (packet->isInstanceOf<PlayerAuthInputPacket>()) {
        PlayerAuthInputPacket* authInputPacket = (PlayerAuthInputPacket*)packet;
        switch (mode.getSelectedValue()) {
        case 1: // Cubecraft
            //authInputPacket->velocity = vec3_t(0, 0, 0);
            break;
        }
    }

    if (packet->isInstanceOf<NetworkLatencyPacket>()) {
        NetworkLatencyPacket* netStack = (NetworkLatencyPacket*)packet;
        switch (mode.getSelectedValue()) {
        case 2: // Hive
            if (speed->isEnabled() || scaffold->isEnabled()) {
                if (GameData::isKeyDown(*input->rightKey) || GameData::isKeyDown(*input->leftKey) || GameData::isKeyDown(*input->backKey)) {
                    netStack->timeStamp = speed->speedFriction * 20.f;
                    netStack->sendBack = true;
                }
            }
            break;
        }
    }
}